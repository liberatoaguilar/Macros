<!DOCTYPE html>
<html style="background-color: #121212;">
    <head>
        <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <title>Macros</title>
    </head>
    <body> 
        <div id="app"> 
            <v-dialog v-model="settings" width="300px">
                <v-card>
                    <v-container>
                        <!--
                        <v-row :justify="'center'"> <v-col cols="auto"> <v-text-field outlined label="Goal Calories" v-model="goalCals"></v-text-field>
                            </v-col>
                        </v-row>
                        <v-row :justify="'center'"> <v-col cols="auto"> <v-text-field
                                    outlined label="Goal Protein" v-model="goalProtein"></v-text-field>
                            </v-col>
                        </v-row>
                        <v-row :justify="'center'"> <v-col cols="auto"> <v-text-field
                                    outlined label="Goal Carbs" v-model="goalCarbs"></v-text-field>
                            </v-col>
                        </v-row>
                        <v-row :justify="'center'"> <v-col cols="auto"> <v-text-field
                                    outlined label="Goal Fat" v-model="goalFat"></v-text-field>
                            </v-col>
                        </v-row>
                        -->
                        <v-row :justify="'center'">
                            <v-col cols="auto">
                                <v-switch
                                    v-model="compact"
                                    label="Compact Cards"
                                    >
                                </v-switch>
                            </v-col>
                        </v-row>
                        <v-row :justify="'center'">
                            <v-btn text @click="exportCsv()"
                                >Export CSV</v-btn> </v-row> <v-row :justify="'center'"> <v-col cols="auto">
                                <v-textarea outlined label="Export" readonly
                                     v-model="JSON.stringify({hist: history, recp: recipes})"></v-textarea>
                            </v-col>
                        </v-row>
                        <v-row :justify="'center'">
                            <v-col cols="auto">
                                <v-textarea outlined label="Import"
                                    v-model="importData"></v-textarea>
                            </v-col>
                        </v-row>
                        <v-row :justify="'center'">
                            <v-col cols="auto">
                                <v-dialog v-model="clearDialog" width=250px>
                                    <template v-slot:activator="{ on, attrs }">
                                        <v-btn text color="red"
                                            v-on="on" v-bind="attrs"
                                            >Clear Data</v-btn>
                                    </template>
                                    <v-card>
                                        <v-container>
                                            <v-row :justify="'center'">
                                                <v-col cols="auto">
                                                    Are you sure?
                                                </v-col>
                                            </v-row>
                                            <v-row :justify="'center'">
                                                <v-col cols="auto">
                                                    <v-btn text color="red"
                                                        @click="clearDialog=false;clearData()">
                                                        Yes
                                                    </v-btn>
                                                </v-col>
                                            </v-row>
                                        </v-container>
                                    </v-card>
                                </v-dialog>
                            </v-col>
                        </v-row>
                    </v-container>
                </v-card>
            </v-dialog>
            <v-dialog v-model="dialog" width="250px">
                <v-card>
                    <v-container>
                        <v-row :justify="'center'">
                            <v-col cols="auto">
                                Calories: {{ this.totalCalories }}
                            </v-col>
                        </v-row>
                        <v-row :justify="'center'">
                            <v-col cols="auto">
                                Protein: {{ this.totalProtein }}
                            </v-col>
                        </v-row>
                        <v-row :justify="'center'">
                            <v-col cols="auto">
                                Carbs: {{ this.totalCarbs }}
                            </v-col>
                        </v-row>
                        <v-row :justify="'center'">
                            <v-col cols="auto">
                                Fat: {{ this.totalFat }}
                            </v-col>
                        </v-row>
                    </v-container>
                </v-card>
            </v-dialog>
            <v-dialog v-model="dialogEdit" width="400px" fullscreen hide-overlay>
                <v-card>
                    <v-container>
                        <v-row dense>
                            <v-col>
                                <v-text-field label="Name" v-model="entryToEdit.name" outlined></v-text-field>
                            </v-col>
                        </v-row>
                        <v-row dense>
                            <v-col>
                                <v-text-field label="Calories" v-model="entryToEdit.calories"
       outlined type="number" min="0"></v-text-field>
                            </v-col>
                        </v-row>
                        <v-row dense>
                            <v-col>
                                <v-text-field label="Protein" v-model="entryToEdit.protein"
       outlined type="number" min="0" suffix="g"></v-text-field>
                            </v-col>
                        </v-row>
                        <v-row dense>
                            <v-col>
                                <v-text-field label="Carbs" v-model="entryToEdit.carbs"
       outlined type="number" min="0" suffix="g"></v-text-field>
                            </v-col>
                        </v-row>
                        <v-row dense>
                            <v-col> 
                                <v-text-field label="Fat" v-model="entryToEdit.fat" outlined
       type="number" min="0" suffix="g"></v-text-field>
                            </v-col>
                        </v-row>
                        <v-row dense>
                            <v-col> 
                                <v-text-field label="Servings" v-model="entryToEdit.amount"
       outlined type="number" min="0"></v-text-field>
                            </v-col>
                        </v-row>
                        <v-row dense :justify="'center'">
                            <v-col cols="auto">
                                <v-btn @click="dialogEdit=false" text>
                                    Done
                                </v-btn>
                            </v-col>
                        </v-row>
                    </v-container>
                </v-card>
           </v-dialog>
           <v-dialog v-model="recipe" fullscreen hide-overlay>
                <v-card>
                    <v-container fluid style="height: 100vh;">
                        <v-row dense :justify="'end'">
                            <v-col cols="auto">
                               <v-icon color="grey" @click="addNewRecipe=true">mdi-plus</v-icon>
                            </v-col>
                        </v-row>
                        <v-row v-if="!recipes.length" dense :justify="'center'">
                            <v-col cols="auto">
                                <v-card-text>No Recipes</v-card-text>
                            </v-col>
                        </v-row>
                        <v-row v-else dense :justify="'center'"  
                                v-for="(r,i) in recipes" :key="i">
                            <v-list-item two-line @click="addRecipe(i); recipe=false;">
                                <v-list-item-content>
                                    <v-list-item-title style="padding-bottom: 5px"><h4>{{r.name}}</h4></v-list-item-title>
                                    <v-list-item-subtitle>Cals: {{r.totalCals}} / Pro: {{r.totalPro}} / Carbs: {{r.totalCarbs}} / Fat: {{r.totalFat}}</v-list-item-subtitle>
                                </v-list-item-content>
                            </v-list-item>
                        </v-row>
                        <v-row dense :justify="'center'">
                            <v-col cols="auto">
                                <v-btn @click="recipe=false" text>
                                    Done
                                </v-btn>
                            </v-col>
                        </v-row>
                    </v-container>
                </v-card>
            </v-dialog>
            <v-dialog v-model="addNewRecipe" fullscreen hide-overlay>
                <v-card>
                    <v-container fluid style="height: 100vh; padding-top:50px;">
                        <v-row dense :justify="'center'">
                            <v-col cols="auto">
                                <v-text-field 
                                    label="Recipe Name" 
                                    v-model="newRecipe.name"
                                    outlined></v-text-field>
                            </v-col>
                        </v-row>
                        <v-row :justify="'start'">
                            <v-list flat>
                                <v-list-item-group multiple v-model="newRecipe.entries">
                                    <v-list-item v-for="(entry, i) in this.entries"
                                        :key="i" 
                                        two-line>
                                        <template v-slot:default="{ active }">
                                            <v-list-item-action>
                                                <v-checkbox :input-value="active"></v-checkbox>
                                            </v-list-item-action>
                                            <v-list-item-content>
                                                <v-list-item-title style="padding-bottom: 5px"><h4>{{entry.name}}</h4></v-list-item-title>
                                                <v-list-item-subtitle>Cals:
                                                    {{entry.calories}} / Pro:
                                                    {{entry.protein}} / Carbs:
                                                {{entry.carbs}} / Fat: {{entry.fat}} /
                                                Ser: {{entry.amount}}</v-list-item-subtitle>
                                            </v-list-item-content>
                                        </template>
                                    </v-list-item>
                                </v-list-item-group>
                            </v-list>
                        </v-row>
                        <v-row :justify="'center'">
                            <v-col cols="auto">
                                <v-btn
                                    @click="addNewRecipe=false;recipe=true;newRecipe.name='';" text>
                                    Cancel
                                </v-btn>
                            </v-col>
                            <v-col cols="auto">
                                <v-btn
                                    @click="addNewRecipe=false;recipe=true;createRecipe();" text>
                                    Create
                                </v-btn>
                            </v-col>
                        </v-row>
                    </v-container>
                </v-card>
            </v-dialog>
            <v-app> 
                <v-container>
                    <v-row :justify="'center'">
                        <v-col cols="auto">
                            <h1 @click="dialog = true">{{ this.totalCalories }}</h1>
                        </v-col>
                    </v-row>
                    <v-row :justify="'end'" dense style="padding-right: 10px;">
                        <v-col cols="auto">
                            <v-icon color="grey" @click="settings=true">mdi-cog</v-icon>
                        </v-col>
                    </v-row>
                    <v-row :justify="'center'" dense>
                        <v-col cols="auto">
                            <add-food @createfood="create($event)" :recipe="recipe"
                                @openrecipes="recipe = true;"
                                ></add-food>
                        </v-col>
                    </v-row>
                    <v-row :justify="'center'">
                        <v-col cols="auto">
                            <history @increase="increaseDay()" @decrease="decreaseDay()"
                               @remove="removeEntry($event)" @edit="editEntry($event)"
                               @minus="minusEntry($event)" @plus="plusEntry($event)"
                               @set="setDay($event)"
                            :current-date="this.currentDate" :entries="this.entries"
                            :compact="this.compact"></history>
                        </v-col>
                    </v-row>
                </v-container>
            </v-app>
        </div>
    </body>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script>

        Vue.component("history",{
            props: ['entries', 'current-date','compact'],
            data() {
                return {
                    editDay: false,
                    daySet: '',
                }
            },
            methods: {
                formatDate(dateParam) { 
                    return dateParam.getMonth()+1 + "/" + dateParam.getDate() + "/" + dateParam.getFullYear();
                },
            },
            template: `
                <v-container>
                    <v-row :justify="'center'">
                        <v-col cols="auto">
                            <h2>History</h2>
                        </v-col>
                    </v-row>
                    <v-row :justify="'center'" dense>
                        <v-col cols="auto">
                            <p><v-icon color="white" @click="$emit('decrease')">mdi-chevron-left</v-icon></p>
                        </v-col>
                        <v-col cols="auto" @click="editDay = true" v-if="!editDay">
                            {{ formatDate(currentDate) }}
                        </v-col>
                       <v-col v-else cols="auto">
       <input type="text" placeholder="mm/dd/yyyy" size=8 style="color: white;" autofocus
       @keyup.enter="editDay = false; $emit('set',daySet); daySet = '';" v-model="daySet"> </input>
                        </v-col>
                        <v-col cols="auto">
                            <p><v-icon color="white" @click="$emit('increase')">mdi-chevron-right</v-icon></p>
                        </v-col>
                    </v-row>
                    <v-row v-for="(entry, i) in entries" :justify="'center'"
       style="padding-bottom: 10px" :key=i>
                        <v-card width=500px> 
                            <v-col> <v-container v-if="!compact">
                                    <v-row dense :justify="'start'">
                                        <v-col maxcols="10">
                                            <h3>{{ entry.name }}</h3> 
                                        </v-col>
                                        <v-col cols="auto">
                                           <v-icon color="grey"
       @click="$emit('edit',i)">mdi-pencil</v-icon>
                                        </v-col>
                                        <v-col cols="auto">
                                            <v-icon color="red" @click="$emit('remove',i)">mdi-close</v-icon>
                                        </v-col>
                                    </v-row>
                                    <v-row dense>
                                        <v-col>
                                            Calories: {{ entry.calories }}
                                        </v-col>
                                    </v-row>
                                    <v-row dense>
                                        <v-col>
                                            Protein: {{ entry.protein }}
                                        </v-col>
                                    </v-row>
                                    <v-row dense>
                                        <v-col>
                                            Carbs: {{ entry.carbs }}
                                        </v-col>
                                    </v-row>
                                    <v-row dense>
                                        <v-col>
                                            Fat: {{ entry.fat }}
                                        </v-col>
                                    </v-row>
                                    <v-row dense>
                                        <v-col>
                                            Servings: {{ entry.amount }}
                                        </v-col>
                                    </v-row>
                                </v-container>
                                <v-container v-else>
                                    <v-row dense :justify="'start'">
                                        <v-col maxcols="10">
                                            <h3>{{ entry.name }}</h3> 
                                        </v-col>
                                        <v-col cols="auto">
                                           <v-icon color="grey"
       @click="$emit('minus',i)">mdi-minus</v-icon>
                                        </v-col>
                                        <v-col cols="auto">
                                           <v-icon color="grey"
       @click="$emit('plus',i)">mdi-plus</v-icon>
                                        </v-col>
                                        <v-col cols="auto">
                                           <v-icon color="grey"
       @click="$emit('edit',i)">mdi-pencil</v-icon>
                                        </v-col>
                                        <v-col cols="auto">
                                            <v-icon color="red" @click="$emit('remove',i)">mdi-close</v-icon>
                                        </v-col>
                                    </v-row>
                                    <v-row dense>
                                        <v-col style="color: #E0E0E0">
       Cals: {{ entry.calories }} / Pro: {{ entry.protein }} / Carb: {{ entry.carbs }}
       / Fat:
       {{ entry.fat }}  / Ser: {{ entry.amount }}
                                        </v-col>
                                    </v-row>
                                </v-container>
                            </v-col>
                        </v-card> 
                    </v-row>
                </v-container>
            `,
    
        });

        Vue.component("addFood",{
            props: ["value"],
            data() {
                return {
                    newFood: {
                        name: "",
                        calories: "",
                        protein: "",
                        carbs: "",
                        fat: "",
                        amount: 1,
                    },
                }
            },
            methods: {
                resetNewFood() {
                    this.newFood = {
                        name: "",
                        calories: "",
                        protein: "",
                        carbs: "",
                        fat: "",
                        amount: 1,
                    };
                }
            },
            template: `
                <v-card width=500px>
                    <v-container>
                        <v-row dense>
                            <v-col>
                                <v-text-field label="Name" v-model="newFood.name" outlined></v-text-field>
                            </v-col>
                        </v-row>
                        <v-row dense>
                            <v-col>
                                <v-text-field label="Calories" v-model="newFood.calories"
       outlined type="number" min="0"></v-text-field>
                            </v-col>
                        </v-row>
                        <v-row dense>
                            <v-col>
                                <v-text-field label="Protein" v-model="newFood.protein"
       outlined type="number" min="0" suffix="g"></v-text-field>
                            </v-col>
                        </v-row>
                        <v-row dense>
                            <v-col>
                                <v-text-field label="Carbs" v-model="newFood.carbs"
       outlined type="number" min="0" suffix="g"></v-text-field>
                            </v-col>
                        </v-row>
                        <v-row dense>
                            <v-col> 
                                <v-text-field label="Fat" v-model="newFood.fat" outlined
       type="number" min="0" suffix="g"></v-text-field>
                            </v-col>
                        </v-row>
                        <v-row dense>
                            <v-col> 
                                <v-text-field label="Servings" v-model="newFood.amount"
       outlined type="number" min="0"></v-text-field>
                            </v-col>
                        </v-row>
                        <v-row :justify="'center'" dense>
                            <v-col cols="auto">
                                <v-btn color="primary"
                    @click="$emit('openrecipes')">Recipes</v-btn>
                            </v-col>
                            <v-col cols="2">
                            </v-col>
                            <v-col cols="auto">
                                <v-btn color="primary"
                    @click="$emit('createfood',newFood); resetNewFood();">Add Food</v-btn>
                            </v-col>
                        </v-row>
                    </v-container>
                </v-card>
            `,
        });

        new Vue({
            el: '#app',
            vuetify: new Vuetify({
                theme: {
                    dark: true
                }
            }),
            data() {
                return {
                    currentDate: new Date(),
                    dateIndex: -1,
                    history: [],
                    dialog: false,
                    dialogEdit: false,
                    entryToEdit: {},
                    settings: false,
                    clearDialog: false,
                    compact: false,
                    recipe: false,
                    addNewRecipe: false,
                    newRecipe: {
                        name: "",
                        totalCals: 0,
                        totalPro: 0,
                        totalCarbs: 0,
                        totalFat: 0,
                        entries: [],
                    },
                    recipes: [],
                    // goalCals: 0,
                    // goalProtein: 0,
                    // goalCarbs: 0,
                    // goalFat: 0,
                    importData: '',
                }
            },
            computed: {
                entries() {
                    if (this.dateIndex != -1 && this.history.length > 0) {
                        return this.history[this.dateIndex].entries;
                    }
                },
                totalCalories() {
                    if (this.dateIndex != -1 && this.history.length > 0) {
                        let sum = 0;
                        for (let i = 0; i < this.history[this.dateIndex].entries.length; i++) {
                            sum += this.history[this.dateIndex].entries[i].calories *
                                       this.history[this.dateIndex].entries[i].amount;
                        }
                        return Math.round(sum*100)/100;
                    }
                },
                totalProtein() {
                    if (this.dateIndex != -1 && this.history.length > 0) {
                        let sum = 0;
                        for (let i = 0; i < this.history[this.dateIndex].entries.length; i++) {
                            sum += this.history[this.dateIndex].entries[i].protein *
                                       this.history[this.dateIndex].entries[i].amount;
                        }
                        return Math.round(sum*100)/100;
                    }
                },
                totalCarbs() {
                    if (this.dateIndex != -1 && this.history.length > 0) {
                        let sum = 0;
                        for (let i = 0; i < this.history[this.dateIndex].entries.length; i++) {
                            sum += this.history[this.dateIndex].entries[i].carbs *
                                       this.history[this.dateIndex].entries[i].amount;
                        }
                        return Math.round(sum*100)/100;
                    }
                },
                totalFat() {
                    if (this.dateIndex != -1 && this.history.length > 0) {
                        let sum = 0;
                        for (let i = 0; i < this.history[this.dateIndex].entries.length; i++) {
                            sum += this.history[this.dateIndex].entries[i].fat *
                                       this.history[this.dateIndex].entries[i].amount;
                        }
                        return Math.round(sum*100)/100;
                    }
                },
            },
            methods: {
                formatDate(dateParam) { 
                    return dateParam.getMonth()+1 + "/" + dateParam.getDate() + "/" + dateParam.getFullYear();
                },
                // Slow
                findDateIndex() {
                    let found = false;
                    for (let i = 0; i < this.history.length; i++) {
                        if (this.history[i].dateObj === this.formatDate(this.currentDate)) {
                            this.dateIndex = i;
                            found = true;
                            break;
                        }
                   } 
                   if (!found) {
                       this.history.push({ dateObj: this.formatDate(this.currentDate), entries: []});
                       this.dateIndex = this.history.length - 1;
                       localStorage.setItem('history',JSON.stringify(this.history));
                       this.save();
                   }
                }, 
                create(food) { 
                        if (
                            food.name &&
                            Number(food.calories) >= 0 &&
                            Number(food.amount) > 0
                        ) {
                        
                        let foodCopy = {
                            name: food.name,
                            calories : Math.round(Number(food.calories)*100)/100,
                            protein : Math.round(Number(food.protein)*100)/100,
                            carbs : Math.round(Number(food.carbs)*100)/100,
                            fat : Math.round(Number(food.fat)*100)/100,
                            amount : Math.round(Number(food.amount)*100)/100,
                        };
                        let found = false;
                        for (let i = 0; i < this.history[this.dateIndex].entries.length; i++)
                        {
                            if (foodCopy.name == this.history[this.dateIndex].entries[i].name)
                            {
                                this.history[this.dateIndex].entries[i].amount +=
                                       foodCopy.amount;
                                found = true;
                                break;
                            }
                        }
                        if (!found) this.history[this.dateIndex].entries.push(foodCopy);
                        this.save();
                    }
                },
                addRecipe(i) {
                    for (let j = 0; j < this.recipes[i].entries.length; j++)
                    {
                        this.create(this.recipes[i].entries[j]);
                    }
                },
                createRecipe() {
                    if (this.newRecipe.name && this.newRecipe.entries.length > 0)
                    {
                        let newEntries = [];
                        for (let i = 0; i < this.newRecipe.entries.length; i++)
                        {
                            let selectedEntry = this.entries[this.newRecipe.entries[i]];
                            newEntries.push(selectedEntry);
                            this.newRecipe.totalCals +=
                                       selectedEntry.calories*selectedEntry.amount;
                            this.newRecipe.totalPro +=
                                       selectedEntry.protein*selectedEntry.amount;
                            this.newRecipe.totalCarbs +=
                                       selectedEntry.carbs*selectedEntry.amount;
                            this.newRecipe.totalFat +=
                                       selectedEntry.fat*selectedEntry.amount;
                        }
                        this.newRecipe.entries = newEntries;
                        this.newRecipe.totalCals = Math.round(Number(this.newRecipe.totalCals)*100)/100;
                        this.newRecipe.totalPro = Math.round(Number(this.newRecipe.totalPro)*100)/100;
                        this.newRecipe.totalCarbs = Math.round(Number(this.newRecipe.totalCarbs)*100)/100;
                        this.newRecipe.totalFat = Math.round(Number(this.newRecipe.totalFat)*100)/100;
                        this.recipes.push(this.newRecipe);

                        this.save();
                    }
                    this.newRecipe =  {
                        name: "",
                        totalCals: 0,
                        totalPro: 0,
                        totalCarbs: 0,
                        totalFat: 0,
                        entries: [],
                    };
                },
                increaseDay() {
                    this.currentDate = new Date(this.currentDate.setDate(this.currentDate.getDate()+1));
                    this.findDateIndex();
                },
                decreaseDay() {
                    this.currentDate = new Date(this.currentDate.setDate(this.currentDate.getDate()-1));
                    this.findDateIndex();
                },
                setDay(date)
                {
                    let day = Number(date.split('/')[1]);
                    let month = Number(date.split('/')[0]);
                    let year = Number(date.split('/')[2]);
                    if (day && month && year)
                    {
                        this.currentDate = new Date();
                        this.currentDate.setDate(day);
                        this.currentDate.setFullYear(year);
                        this.currentDate.setMonth(month-1);
                        this.findDateIndex();
                    }
                },
                removeEntry(index) {
                    this.history[this.dateIndex].entries.splice(index,1);
                    this.save();
                },
                editEntry(index) {
                    this.entryToEdit = this.history[this.dateIndex].entries[index];
                    this.dialogEdit = true;
                },
                minusEntry(index) {
                    if (this.history[this.dateIndex].entries[index].amount > 1)
                    {
                        this.history[this.dateIndex].entries[index].amount--;
                    };
                    this.save();
                },
                plusEntry(index) {
                    this.history[this.dateIndex].entries[index].amount++;
                    this.save();
                },
                save() {
                    localStorage.setItem('history',JSON.stringify(this.history));
                    localStorage.setItem('compact',JSON.stringify(this.compact));
                    localStorage.setItem('recipes',JSON.stringify(this.recipes));
                    // localStorage.setItem('goalCals',this.goalCals);
                    // localStorage.setItem('goalProtein',this.goalProtein);
                    // localStorage.setItem('goalCarbs',this.goalCarbs);
                    // localStorage.setItem('goalFat',this.goalFat);
                },
                clearData() {
                    localStorage.clear();
                    this.history = [];
                    this.recipes = [];
                    this.compact = false;
                    this.findDateIndex();
                    // this.findDateIndex();
                    // this.goalCals = 0;
                    // this.goalProtein = 0;
                    // this.goalCarbs = 0;
                    // this.goalFat = 0;
                },
                createCsv() {
                    let text = "Date,Calories,Protein,Carbs,Fat\n";
                    for (let i = 0; i < this.history.length; i++)
                    {
                        text += this.history[i].dateObj + ',';
                        let calories = 0;
                        let protein = 0;
                        let carbs = 0;
                        let fat = 0;
                        for (let j = 0; j < this.history[i].entries.length; j++)
                        {
                            calories += Math.round(Number(this.history[i].entries[j].calories)*Number(this.history[i].entries[j].amount)*100)/100;
                            protein += Math.round(Number(this.history[i].entries[j].protein)*Number(this.history[i].entries[j].amount)*100)/100;
                            carbs += Math.round(Number(this.history[i].entries[j].carbs)*Number(this.history[i].entries[j].amount)*100)/100;
                            fat += Math.round(Number(this.history[i].entries[j].fat)*Number(this.history[i].entries[j].amount)*100)/100;
                        }
                        text += calories+','+protein+','+carbs+','+fat+'\n';
                    }
                    return text;
                },
                compareDate(date1, date2)
                {
                    let d1 = date1.split('/');
                    let d2 = date2.split('/');
                    if (Number(d1[2]) >  Number(d2[2])) return true;
                    else if (Number(d1[2]) <  Number(d2[2])) return false;
                    else {
                        if (Number(d1[0]) >  Number(d2[0])) return true;
                        else if (Number(d1[0]) <  Number(d2[0])) return false;
                        else {
                            if (Number(d1[1]) >  Number(d2[1])) return true;
                            else return false;
                        }
                    }
                },
                sortCsv(text) {
                    let listText = text.split('\n');
                    for (let i = 1; i < listText.length; i++)
                    {
                        for (let j = 1; j < listText.length-1; j++)
                        {
                            let date1 = listText[j].split(',')[0];
                            let date2 = listText[j+1].split(',')[0];
                            if (this.compareDate(date1, date2))
                            {
                                let temp = listText[j];
                                listText[j] = listText[j+1];
                                listText[j+1] = temp;
                            }
                        }
                    }
                    let sortedText = "";
                    for (let i = 0; i < listText.length; i++)
                    {
                        sortedText += listText[i]+'\n';
                    }
                    return sortedText;
                },
                exportCsv() {
                    let text = this.sortCsv(this.createCsv());
                    let element = document.createElement("a");
                    element.setAttribute("href", "data:text/plain;charset=utf-8," + encodeURIComponent(text));
                    element.setAttribute("download", "macros.csv");
                    element.style.display = "none";
                    document.body.appendChild(element);
                    element.click();
                    document.body.removeChild(element);
                },
            },
            mounted() {
                this.history = localStorage.getItem('history') ? JSON.parse(localStorage.getItem('history')) : [];
                this.compact = localStorage.getItem('compact') ?  JSON.parse(localStorage.getItem('compact')) : false;
                this.recipes = localStorage.getItem('recipes') ?  JSON.parse(localStorage.getItem('recipes')) : [];
                this.findDateIndex();
                // this.goalCals = localStorage.getItem('goalCals') ?
                //             localStorage.getItem('goalCals') : 0;
                // this.goalProtein = localStorage.getItem('goalProtein') ?
                //             localStorage.getItem('goalProtein') : 0;
                // this.goalCarbs = localStorage.getItem('goalCarbs') ?
                //             localStorage.getItem('goalCarbs') : 0;
                // this.goalFat = localStorage.getItem('goalFat') ?
                //             localStorage.getItem('goalFat') : 0;
            },
            watch: {
                dialogEdit() {
                    this.save();
                },
                settings() {
                    this.save();
                    if (this.importData && !this.settings)
                    {
                        this.history = JSON.parse(this.importData).hist;
                        this.recipes = JSON.parse(this.importData).recp;
                        this.findDateIndex();
                        this.importData = '';
                        this.save();
                    }
                },
            }
        });
    </script>
</html>
